defaults: &defaults
  working_directory: /wp-e2e-tests-jetpack
  docker:
    - image: hoverduck/wp-e2e-tests:0.0.3
      environment:
        NODE_ENV: test
jetpack_host_defaults: &jetpack_host_defaults
  <<: *defaults
  working_directory: /wp-e2e-tests-jetpack
  steps:
     - attach_workspace:
         at: /wp-e2e-tests-jetpack/wp-e2e-tests
     - run: cd wp-e2e-tests && git checkout origin/${E2E_BRANCH-master}
     - run: cd wp-e2e-tests && ./run.sh -R -j
version: 2
jobs:
  configure:
    <<: *defaults
    steps:
      - checkout
      - run: git submodule init && git submodule update --remote --force
      - restore_cache:
          key: << checksum "wp-e2e-tests/package.json" >>
      - run: cd wp-e2e-tests && npm install
      - save_cache:
          paths:
            - wp-e2e-tests/node_modules
          key: << checksum "wp-e2e-tests/package.json" >>
      - persist_to_workspace:
          root: wp-e2e-tests
          paths: .
  bluehost:
    <<: *jetpack_host_defaults
    environment:
      JETPACKHOST: BLUEHOST
  pressable:
    <<: *jetpack_host_defaults
    environment:
      JETPACKHOST: PRESSABLE
  godaddy:
    <<: *jetpack_host_defaults
    environment:
      JETPACKHOST: GODADDY
  gather_artifacts:
    <<: *defaults
    steps:
      - store_test_results:
          path: wp-e2e-tests/reports/
      - store_artifacts:
          path: wp-e2e-tests/reports/
      - store_artifacts:
          path: wp-e2e-tests/screenshots/
workflows:
  version: 2
  test_jetpack_hosts:
    jobs:
      - configure
      - bluehost:
          requires:
            - configure
      - pressable:
          requires:
            - configure
      - godaddy:
          requires:
            - configure
      - gather_artifacts:
          requires:
            - bluehost
            - pressable
            - godaddy
